<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Timer</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233b82f6'%3E%3Cpath d='M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z'/%3E%3C/svg%3E">
    <style>
        :root {
            --bg-color: #0b1019;
            --card-bg: #111827;
            --primary-blue: #3b82f6;
            --primary-glow: rgba(59, 130, 246, 0.6);
            --track-color: #1f2937;
            --text-main: #e2e8f0;
            --text-muted: #64748b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            transition: background 0.3s;
        }

        .container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 480px;
            padding: 20px;
        }

        /* --- SETTINGS BAR --- */
        .settings-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
            width: 100%;
            justify-content: center;
        }

        .sound-row {
            display: flex;
            align-items: center;
            background: var(--card-bg);
            padding: 5px;
            border-radius: 12px;
            border: 1px solid var(--track-color);
        }

        select {
            appearance: none;
            background-color: var(--card-bg);
            color: var(--text-main);
            border: none;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            outline: none;
            text-align: center;
            font-weight: 500;
            border-radius: 8px;
            min-width: 140px;
        }
        select option { background-color: var(--card-bg); color: var(--text-main); padding: 10px; }
        select:hover { color: var(--primary-blue); }

        .preview-btn {
            background: transparent;
            border: none;
            color: var(--primary-blue);
            cursor: pointer;
            padding: 5px 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1px solid var(--track-color);
            transition: transform 0.1s;
            width: 40px;
        }
        .preview-btn:active { transform: scale(0.9); }

        /* Volume Slider */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            background: var(--card-bg);
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid var(--track-color);
        }
        .volume-icon { width: 18px; height: 18px; fill: currentColor; }
        
        input[type=range] {
            -webkit-appearance: none;
            width: 80px;
            height: 4px;
            background: var(--track-color);
            border-radius: 2px;
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary-blue);
            cursor: pointer;
            box-shadow: 0 0 10px var(--primary-glow);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* --- CIRCULAR PROGRESS BAR --- */
        .timer-circle {
            position: relative;
            width: 360px;
            height: 360px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .timer-circle svg {
            transform: rotate(-90deg) scaleY(-1);
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        circle {
            fill: transparent;
            stroke-width: 8;
            stroke-linecap: round;
        }

        .circle-bg {
            stroke: var(--track-color);
        }

        .circle-progress {
            stroke: var(--primary-blue);
            transition: stroke-dashoffset 1s linear; 
            filter: drop-shadow(0 0 12px var(--primary-glow));
        }

        /* --- TIMER DISPLAY & INPUTS --- */
        .time-wrapper {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            height: 100%;
            top: 0; left: 0;
            z-index: 5;
        }

        .timer-display {
            font-size: 4.5rem;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
            color: var(--text-main);
            user-select: none;
            transition: color 0.2s, transform 0.2s, opacity 0.2s;
        }
        
        .timer-display.editable { cursor: pointer; }
        .timer-display.editable:hover { color: var(--primary-blue); transform: scale(1.02); }
        .timer-display.locked { cursor: default; opacity: 1; }

        /* Input Mode Styles */
        .input-group {
            display: none;
            flex-direction: row;
            align-items: flex-end; 
            gap: 6px;
            margin-bottom: 10px;
        }
        .input-group.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .input-unit { display: flex; flex-direction: column; align-items: center; }

        .time-input {
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--track-color);
            color: var(--primary-blue);
            font-size: 3.5rem;
            width: 80px;
            text-align: center;
            outline: none;
            transition: border-color 0.2s;
            padding-bottom: 0;
            font-weight: 300;
        }
        .time-input:focus { border-bottom-color: var(--primary-blue); }
        .time-input::placeholder { color: var(--text-muted); opacity: 0.2; }

        .input-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 5px;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .colon {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 20px;
            opacity: 0.5;
        }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* --- CONTROLS --- */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            z-index: 10;
        }

        button {
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background-color: var(--primary-blue);
            color: white;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
            min-width: 140px;
            justify-content: center;
        }
        .btn-primary:hover { background-color: #2563eb; transform: scale(1.05); }
        .btn-primary:active { transform: scale(0.95); }
        .btn-primary.alarm-ringing {
            background-color: #ef4444; 
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            animation: pulse 1s infinite;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--track-color);
            color: var(--text-muted);
        }
        .btn-secondary:hover { border-color: var(--text-main); color: var(--text-main); }

        .icon { width: 18px; height: 18px; fill: currentColor; }

        /* --- PRESETS --- */
        .presets {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .preset-btn {
            background-color: var(--card-bg);
            color: var(--text-muted);
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 0.9rem;
            border: 1px solid transparent;
        }
        .preset-btn:hover { border-color: var(--primary-blue); color: var(--primary-blue); }

    </style>
</head>
<body>

    <div class="container">
        
        <!-- Settings Bar -->
        <div class="settings-bar">
            <!-- Sound Selector -->
            <div class="sound-row">
                <select id="soundSelect">
                    <option value="loud_alarm">Loud Alarm</option>
                    <option value="fire_alarm">Fire Alarm</option>
                    <option value="church_bell">Church Bell</option>
                    <option value="alert_alarm">Alert Alarm</option>
                    <option value="emergency_alarm">Emergency</option>
                    <option value="rooster">Rooster</option>
                    <option value="flute">Flute</option>
                </select>
                <button class="preview-btn" id="previewBtn" title="Preview Sound">▶</button>
            </div>

            <!-- Volume Control -->
            <div class="volume-control" title="Volume">
                <svg class="volume-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1.0">
            </div>
        </div>

        <!-- Circular Progress -->
        <div class="timer-circle">
            <svg viewBox="0 0 360 360">
                <circle class="circle-bg" cx="180" cy="180" r="150"></circle>
                <circle class="circle-progress" id="progressRing" cx="180" cy="180" r="150"></circle>
            </svg>
            
            <div class="time-wrapper">
                <!-- Standard Display -->
                <div class="timer-display editable" id="display" title="Click to edit time">00:00:00</div>
                
                <!-- Custom Input Fields -->
                <div class="input-group" id="inputGroup">
                    <div class="input-unit">
                        <input type="number" class="time-input" id="inH" placeholder="00" max="99">
                        <span class="input-label">HR</span>
                    </div>
                    <span class="colon">:</span>
                    <div class="input-unit">
                        <input type="number" class="time-input" id="inM" placeholder="00" max="59">
                        <span class="input-label">MIN</span>
                    </div>
                    <span class="colon">:</span>
                    <div class="input-unit">
                        <input type="number" class="time-input" id="inS" placeholder="00" max="59">
                        <span class="input-label">SEC</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="startBtn" class="btn-primary">
                <svg class="icon" id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                <span id="btnText">Start</span>
            </button>
            <button id="resetBtn" class="btn-secondary">Reset</button>
        </div>

        <div class="presets">
            <button class="preset-btn" data-m="15">15 Min</button>
            <button class="preset-btn" data-m="24">24 Min</button>
            <button class="preset-btn" data-m="30">30 Min</button>
            <button class="preset-btn" data-m="60">1 Hour</button>
        </div>
        
    </div>

    <script>
        // --- WORKER ---
        const workerCode = `
            let interval;
            self.onmessage = function(e) {
                if (e.data === 'start') {
                    interval = setInterval(() => self.postMessage('tick'), 1000);
                } else if (e.data === 'stop') {
                    clearInterval(interval);
                }
            };
        `;
        const blob = new Blob([workerCode], { type: "application/javascript" });
        const worker = new Worker(URL.createObjectURL(blob));

        // --- DOM ELEMENTS ---
        const display = document.getElementById('display');
        const progressRing = document.getElementById('progressRing');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const btnText = document.getElementById('btnText');
        const playIcon = document.getElementById('playIcon');
        const soundSelect = document.getElementById('soundSelect');
        const previewBtn = document.getElementById('previewBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const inputGroup = document.getElementById('inputGroup');
        const inH = document.getElementById('inH');
        const inM = document.getElementById('inM');
        const inS = document.getElementById('inS');

        // --- ICONS ---
        const ICON_PLAY = '<path d="M8 5v14l11-7z"/>';
        const ICON_PAUSE = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
        const ICON_STOP = '<rect x="6" y="6" width="12" height="12"/>';

        // --- AUDIO SOURCES (WAV) ---
        const SOUNDS = {
            loud_alarm: "https://assets.mixkit.co/active_storage/sfx/2869/2869.wav",
            fire_alarm: "https://assets.mixkit.co/active_storage/sfx/995/995.wav",
            church_bell: "https://assets.mixkit.co/active_storage/sfx/603/603.wav",
            alert_alarm: "https://assets.mixkit.co/active_storage/sfx/1005/1005.wav",
            emergency_alarm: "https://assets.mixkit.co/active_storage/sfx/1000/1000.wav",
            rooster: "https://assets.mixkit.co/active_storage/sfx/2462/2462.wav",
            flute: "https://assets.mixkit.co/active_storage/sfx/2317/2317.wav"
        };

        // --- VARIABLES ---
        let totalSeconds = 15 * 60; 
        let remainingSeconds = totalSeconds;
        let isRunning = false;
        let isInputMode = false;
        let wakeLock = null;
        let alarmInterval = null;
        let masterVolume = 1.0; 
        
        // SINGLE PERSISTENT AUDIO PLAYER
        // This is key for streaming/buffering. We don't recreate it.
        const audioPlayer = new Audio();
        audioPlayer.preload = "auto"; // Tell browser to buffer automatically
        let isPreviewing = false;

        // Circular Progress
        const radius = progressRing.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        progressRing.style.strokeDasharray = `${circumference} ${circumference}`;
        progressRing.style.strokeDashoffset = 0;

        // --- AUDIO ENGINE ---

        // Initialize Audio
        function initAudio() {
            // Set source immediately to allow background buffering
            if (audioPlayer.src !== SOUNDS[soundSelect.value]) {
                audioPlayer.src = SOUNDS[soundSelect.value];
            }
            audioPlayer.volume = masterVolume;
        }

        // Switch Sound immediately when dropdown changes
        function switchSound() {
            const wasPlaying = isPreviewing;
            if (wasPlaying) stopAudio();
            
            // Changing src triggers the browser to start buffering the new file
            audioPlayer.src = SOUNDS[soundSelect.value];
            audioPlayer.load(); // Force buffer start
            
            if (wasPlaying) {
                // If we were previewing, keep playing the new sound
                togglePreview(); 
            }
        }

        function playSound() {
            audioPlayer.currentTime = 0;
            audioPlayer.volume = masterVolume;
            const playPromise = audioPlayer.play();
            
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.error("Playback failed (likely user interaction needed)", error);
                });
            }
        }

        function stopAudio() {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            if (isPreviewing) {
                isPreviewing = false;
                previewBtn.textContent = '▶';
            }
        }

        // The "Unlock" trick:
        // Play and immediately pause on user interaction (Start button)
        // This authorizes the browser to play loud sound later without interaction.
        function unlockAudio() {
            const originalVol = audioPlayer.volume;
            audioPlayer.volume = 0; 
            audioPlayer.play().then(() => {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                audioPlayer.volume = originalVol; 
            }).catch(() => {});
        }

        function togglePreview() {
            if (isPreviewing) {
                stopAudio();
            } else {
                isPreviewing = true;
                previewBtn.textContent = '■';
                playSound();
                
                // Reset button when sound ends naturally
                audioPlayer.onended = () => {
                    isPreviewing = false;
                    previewBtn.textContent = '▶';
                    audioPlayer.onended = null; // Clean up listener
                };
            }
        }

        function startAlarmLoop() {
            // Play immediately
            playSound();
            // Loop every 3s
            alarmInterval = setInterval(() => {
                playSound();
            }, 3000);
            document.title = "Time's Up!";
        }

        // --- WAKE LOCK ---
        async function requestWakeLock() {
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
        function releaseWakeLock() {
            if (wakeLock) { wakeLock.release(); wakeLock = null; }
        }

        // --- TIMER LOGIC ---
        function formatTime(totalSecs) {
            const h = Math.floor(totalSecs / 3600);
            const m = Math.floor((totalSecs % 3600) / 60);
            const s = totalSecs % 60;
            if (h > 0) return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function setProgress(percent) {
            const offset = (percent / 100) * circumference;
            progressRing.style.strokeDashoffset = offset;
        }

        function updateDisplay() {
            display.textContent = formatTime(remainingSeconds);
            const percent = totalSeconds === 0 ? 0 : ((totalSeconds - remainingSeconds) / totalSeconds) * 100;
            setProgress(percent);
            
            if (isRunning) document.title = `(${formatTime(remainingSeconds)}) Focus`;
            else document.title = 'Focus Timer';

            if (isRunning || alarmInterval) {
                display.classList.remove('editable');
                display.classList.add('locked');
            } else {
                display.classList.add('editable');
                display.classList.remove('locked');
            }
        }

        function finishTimer() {
            stopTimer(false); 
            remainingSeconds = 0;
            updateDisplay();
            startAlarmLoop();
            
            playIcon.innerHTML = ICON_STOP;
            btnText.textContent = 'Stop';
            startBtn.classList.add('alarm-ringing');
            startBtn.onclick = resetTimer; 
        }

        function startTimer() {
            if (isInputMode) confirmCustomTime();

            if (isRunning) {
                stopTimer(); // Pause
                return;
            }
            
            unlockAudio(); // Authorize Audio

            isRunning = true;
            worker.postMessage('start');
            requestWakeLock();
            
            playIcon.innerHTML = ICON_PAUSE;
            btnText.textContent = 'Pause';
            startBtn.style.backgroundColor = 'var(--text-muted)';
            updateDisplay(); 
        }

        function stopTimer(manual = true) {
            isRunning = false;
            worker.postMessage('stop');
            releaseWakeLock();
            
            if (manual) {
                playIcon.innerHTML = ICON_PLAY;
                btnText.textContent = 'Start';
                startBtn.style.backgroundColor = 'var(--primary-blue)';
            }
            updateDisplay();
        }

        function resetTimer() {
            stopTimer(true);
            if (alarmInterval) { clearInterval(alarmInterval); alarmInterval = null; }
            stopAudio();

            startBtn.classList.remove('alarm-ringing');
            startBtn.onclick = startTimer;
            
            remainingSeconds = totalSeconds;
            updateDisplay();
        }

        // --- INPUT LOGIC ---
        function toggleInputMode() {
            if (isRunning || alarmInterval) return;
            isInputMode = !isInputMode;
            if (isInputMode) {
                display.style.display = 'none';
                inputGroup.classList.add('active');
                inH.value = ''; inM.value = ''; inS.value = '';
                inM.focus();
            } else {
                display.style.display = 'block';
                inputGroup.classList.remove('active');
                updateDisplay();
            }
        }

        function confirmCustomTime() {
            const h = parseInt(inH.value) || 0;
            const m = parseInt(inM.value) || 0;
            const s = parseInt(inS.value) || 0;
            const newTotal = (h * 3600) + (m * 60) + s;
            if (newTotal > 0) { totalSeconds = newTotal; remainingSeconds = totalSeconds; }
            isInputMode = false;
            display.style.display = 'block';
            inputGroup.classList.remove('active');
            updateDisplay();
        }

        // --- LISTENERS ---
        worker.onmessage = function(e) {
            if (e.data === 'tick') {
                if (remainingSeconds > 0) { remainingSeconds--; updateDisplay(); } 
                else { finishTimer(); }
            }
        };

        startBtn.onclick = startTimer;
        resetBtn.onclick = resetTimer;
        
        volumeSlider.addEventListener('input', (e) => {
            masterVolume = parseFloat(e.target.value);
            audioPlayer.volume = masterVolume;
        });
        
        display.addEventListener('click', toggleInputMode);
        previewBtn.addEventListener('click', togglePreview);
        soundSelect.addEventListener('change', switchSound);

        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.onclick = () => {
                if (isInputMode) toggleInputMode(); 
                if (alarmInterval) resetTimer();
                stopTimer();
                totalSeconds = parseInt(btn.getAttribute('data-m')) * 60;
                remainingSeconds = totalSeconds;
                updateDisplay();
                startTimer();
            };
        });

        [inH, inM, inS].forEach(inp => {
            inp.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { confirmCustomTime(); startTimer(); }
            });
        });

        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') requestWakeLock();
        });

        // Initialize audio on load
        initAudio();
        updateDisplay();
    </script>
</body>
</html>
